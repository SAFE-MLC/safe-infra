server {
  listen 8080;
  listen [::]:8080;

  # Health
  location = /health {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # ---------- BACKOFFICE ----------
  # /api/internal/* -> backoffice (se mantiene el prefijo)
  location ^~ /api/internal/ {
    # Preflight CORS
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_backoffice:3000;  # SIN barra final: conserva /api/internal/...
    proxy_redirect off;
  }

  # /api/staff/* -> backoffice (se mantiene el prefijo)
  location ^~ /api/staff/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_backoffice:3000;  # SIN barra final → conserva /api/staff/...
    proxy_redirect off;
  }

  # /api/tickets/* -> backoffice (se mantiene el prefijo)
  location ^~ /api/tickets/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_backoffice:3000;  # SIN barra final → conserva /api/tickets/...
    proxy_redirect off;
  }

  # ---------- GATE ----------
  # /api/gate/* -> gate-ms (se QUITA el prefijo)
  location ^~ /api/gate/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_gate:8080/;   # CON barra final → quita /api/gate/
    proxy_redirect off;
  }

  # ---------- ZONE ----------
  # /api/zone/* -> zone-ms (se QUITA el prefijo)
  location ^~ /api/zone/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_zone:8080/;   # CON barra final → quita /api/zone/
    proxy_redirect off;
  }

  # ---------- Catch-all /api ----------
  location /api/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    return 404;
  }
}
