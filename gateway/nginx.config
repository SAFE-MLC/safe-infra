server {
  listen 8080;
  listen [::]:8080;

  # Health
  location = /health {
    add_header Content-Type text/plain;
    return 200 'ok';
  }

  # ---------- BACKOFFICE ----------
  # FastAPI sirve /api/staff/* y /api/tickets/* tal cual
  location ^~ /api/staff/ {
    # Preflight
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_backoffice:3000;  # SIN barra final → conserva /api/staff/...
    proxy_redirect off;
  }

  location ^~ /api/tickets/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_backoffice:3000;  # SIN barra final → conserva /api/tickets/...
    proxy_redirect off;
  }

  # ---------- GATE ----------
  # Front:  /api/gate/validate/scan → Backend: /validate/scan
  location ^~ /api/gate/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_gate:8080/;   # CON barra final → quita el prefijo /api/gate/
    proxy_redirect off;
  }

  # ---------- ZONE ----------
  # Front: /api/zone/zones/checkpoint/scan → Backend: /zones/checkpoint/scan
  location ^~ /api/zone/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    add_header Access-Control-Allow-Origin * always;

    proxy_pass http://safe_zone:8080/;   # CON barra final → quita el prefijo /api/zone/
    proxy_redirect off;
  }

  # ---------- Catch-all /api (AL FINAL, SIN ^~) ----------
  # Si alguna /api/* no matcheó arriba: permite preflight y 404 al resto
  location /api/ {
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization,Content-Type,Accept" always;
      add_header Access-Control-Max-Age 86400 always;
      return 204;
    }
    return 404;
  }
}
